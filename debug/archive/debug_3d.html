<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dé¢„è§ˆè°ƒè¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .preview-container {
            width: 100%;
            height: 400px;
            border: 2px solid #007bff;
            border-radius: 5px;
            background: #f8f9fa;
            position: relative;
        }
        .log {
            background: #333;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ 3Dé¢„è§ˆåŠŸèƒ½è°ƒè¯•</h1>
        
        <div class="test-section">
            <h3>1. Three.jsåº“åŠ è½½æµ‹è¯•</h3>
            <div id="threejs-status" class="info">æ£€æŸ¥ä¸­...</div>
        </div>
        
        <div class="test-section">
            <h3>2. OrbitControlsåŠ è½½æµ‹è¯•</h3>
            <div id="controls-status" class="info">æ£€æŸ¥ä¸­...</div>
        </div>
        
        <div class="test-section">
            <h3>3. åŸºç¡€Three.jsåœºæ™¯æµ‹è¯•</h3>
            <div id="basic-scene" class="preview-container">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div>åŸºç¡€3Dåœºæ™¯æµ‹è¯•</div>
                    <div id="basic-status">åˆå§‹åŒ–ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>4. è‡ªå®šä¹‰é¢„è§ˆç±»æµ‹è¯•</h3>
            <div id="custom-preview" class="preview-container">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div>æ™¶ä½“é¢„è§ˆæµ‹è¯•</div>
                    <div id="custom-status">ç­‰å¾…æµ‹è¯•...</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>5. CIFè§£ææµ‹è¯•</h3>
            <textarea id="cif-input" rows="10" cols="80" placeholder="è¯·ç²˜è´´CIFæ–‡ä»¶å†…å®¹è¿›è¡Œæµ‹è¯•...">
data_simple_crystal
_cell_length_a    5.6402
_cell_length_b    5.6402
_cell_length_c    5.6402
_cell_angle_alpha 90.0
_cell_angle_beta  90.0
_cell_angle_gamma 90.0
_space_group_name_H-M_alt 'F m -3 m'
_space_group_IT_number 225

loop_
_atom_site_label
_atom_site_type_symbol
_atom_site_fract_x
_atom_site_fract_y
_atom_site_fract_z
Na1 Na 0.0 0.0 0.0
Na2 Na 0.0 0.5 0.5
Na3 Na 0.5 0.0 0.5
Na4 Na 0.5 0.5 0.0
Cl1 Cl 0.5 0.5 0.5
Cl2 Cl 0.5 0.0 0.0
Cl3 Cl 0.0 0.5 0.0
Cl4 Cl 0.0 0.0 0.5
            </textarea>
            <br><br>
            <button onclick="testCIFParsing()">æµ‹è¯•CIFè§£æ</button>
            <div id="cif-status"></div>
        </div>
        
        <div class="test-section">
            <h3>6. è°ƒè¯•æ—¥å¿—</h3>
            <div id="debug-log" class="log">ç­‰å¾…æ—¥å¿—...</div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    
    <!-- è‡ªå®šä¹‰é¢„è§ˆç±» -->
    <script src="/static/js/crystal_preview.js"></script>
    <script src="/static/js/advanced_crystal_preview.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = 'Log cleared.';
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = type;
        }

        // 1. æ£€æŸ¥Three.js
        function testThreeJS() {
            log('ğŸ” æ£€æŸ¥Three.jsåº“...');
            if (typeof THREE !== 'undefined') {
                updateStatus('threejs-status', 'âœ… Three.jså·²æˆåŠŸåŠ è½½', 'success');
                log('âœ… Three.jsç‰ˆæœ¬: ' + THREE.REVISION, 'success');
                return true;
            } else {
                updateStatus('threejs-status', 'âŒ Three.jsæœªåŠ è½½', 'error');
                log('âŒ Three.jsæœªåŠ è½½', 'error');
                return false;
            }
        }

        // 2. æ£€æŸ¥OrbitControls
        function testOrbitControls() {
            log('ğŸ” æ£€æŸ¥OrbitControls...');
            if (typeof THREE !== 'undefined' && THREE.OrbitControls) {
                updateStatus('controls-status', 'âœ… OrbitControlså·²åŠ è½½', 'success');
                log('âœ… OrbitControlså¯ç”¨', 'success');
                return true;
            } else {
                updateStatus('controls-status', 'âŒ OrbitControlsæœªåŠ è½½', 'error');
                log('âŒ OrbitControlsä¸å¯ç”¨', 'error');
                return false;
            }
        }

        // 3. æµ‹è¯•åŸºç¡€Three.jsåœºæ™¯
        function testBasicScene() {
            log('ğŸ” åˆ›å»ºåŸºç¡€Three.jsåœºæ™¯...');
            try {
                const container = document.getElementById('basic-scene');
                
                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';
                
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setClearColor(0xf0f0f0);
                container.appendChild(renderer.domElement);
                
                // æ·»åŠ ç¯å…‰
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                scene.add(directionalLight);
                
                // åˆ›å»ºä¸€ä¸ªæ—‹è½¬çš„ç«‹æ–¹ä½“
                const geometry = new THREE.BoxGeometry();
                const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);
                
                // æ·»åŠ OrbitControls
                if (THREE.OrbitControls) {
                    const controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.25;
                }
                
                camera.position.z = 5;
                
                // åŠ¨ç”»å¾ªç¯
                function animate() {
                    requestAnimationFrame(animate);
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                    renderer.render(scene, camera);
                }
                animate();
                
                updateStatus('basic-status', 'âœ… åŸºç¡€3Dåœºæ™¯è¿è¡Œæ­£å¸¸', 'success');
                log('âœ… åŸºç¡€Three.jsåœºæ™¯åˆ›å»ºæˆåŠŸ', 'success');
                return true;
                
            } catch (error) {
                updateStatus('basic-status', 'âŒ åŸºç¡€åœºæ™¯åˆ›å»ºå¤±è´¥', 'error');
                log('âŒ åŸºç¡€åœºæ™¯é”™è¯¯: ' + error.message, 'error');
                return false;
            }
        }

        // 4. æµ‹è¯•è‡ªå®šä¹‰é¢„è§ˆç±»
        function testCustomPreview() {
            log('ğŸ” æµ‹è¯•è‡ªå®šä¹‰é¢„è§ˆç±»...');
            try {
                const container = document.getElementById('custom-preview');
                container.innerHTML = '';
                
                // æ£€æŸ¥é¢„è§ˆç±»æ˜¯å¦å­˜åœ¨
                if (typeof AdvancedCrystalPreview !== 'undefined') {
                    log('âœ… AdvancedCrystalPreviewç±»å·²åŠ è½½', 'success');
                    
                    // åˆ›å»ºé¢„è§ˆå®ä¾‹
                    const preview = new AdvancedCrystalPreview('custom-preview');
                    
                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ç»“æ„
                    const testStructure = {
                        sites: [
                            { coords: [0, 0, 0], species: [{ element: 'Na', occu: 1 }] },
                            { coords: [2, 2, 2], species: [{ element: 'Cl', occu: 1 }] }
                        ],
                        lattice: {
                            matrix: [[4, 0, 0], [0, 4, 0], [0, 0, 4]]
                        }
                    };
                    
                    preview.loadStructureFromPymatgenStyle(testStructure);
                    
                    updateStatus('custom-status', 'âœ… è‡ªå®šä¹‰é¢„è§ˆç±»å·¥ä½œæ­£å¸¸', 'success');
                    log('âœ… AdvancedCrystalPreviewæµ‹è¯•æˆåŠŸ', 'success');
                    return true;
                    
                } else if (typeof CrystalPreview !== 'undefined') {
                    log('âš ï¸ å›é€€åˆ°åŸºç¡€CrystalPreview', 'warning');
                    
                    const preview = new CrystalPreview('custom-preview');
                    updateStatus('custom-status', 'âš ï¸ ä½¿ç”¨åŸºç¡€é¢„è§ˆç±»', 'warning');
                    log('âš ï¸ ä½¿ç”¨åŸºç¡€CrystalPreview', 'warning');
                    return true;
                    
                } else {
                    updateStatus('custom-status', 'âŒ é¢„è§ˆç±»æœªåŠ è½½', 'error');
                    log('âŒ æ— å¯ç”¨çš„é¢„è§ˆç±»', 'error');
                    return false;
                }
                
            } catch (error) {
                updateStatus('custom-status', 'âŒ é¢„è§ˆç±»æµ‹è¯•å¤±è´¥', 'error');
                log('âŒ è‡ªå®šä¹‰é¢„è§ˆé”™è¯¯: ' + error.message, 'error');
                return false;
            }
        }

        // 5. æµ‹è¯•CIFè§£æ
        function testCIFParsing() {
            log('ğŸ” æµ‹è¯•CIFè§£æ...');
            const cifInput = document.getElementById('cif-input').value;
            const statusDiv = document.getElementById('cif-status');
            
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨CIFè§£æå‡½æ•°
                // æš‚æ—¶åªåšåŸºæœ¬éªŒè¯
                if (cifInput.includes('_cell_length_a') && cifInput.includes('_atom_site_label')) {
                    statusDiv.innerHTML = '<div class="success">âœ… CIFæ ¼å¼æ£€æŸ¥é€šè¿‡</div>';
                    log('âœ… CIFæ ¼å¼éªŒè¯æˆåŠŸ', 'success');
                } else {
                    statusDiv.innerHTML = '<div class="error">âŒ CIFæ ¼å¼ä¸å®Œæ•´</div>';
                    log('âŒ CIFæ ¼å¼éªŒè¯å¤±è´¥', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="error">âŒ CIFè§£æé”™è¯¯: ' + error.message + '</div>';
                log('âŒ CIFè§£æé”™è¯¯: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæ‰€æœ‰æµ‹è¯•
        window.addEventListener('load', function() {
            log('ğŸš€ å¼€å§‹3Dé¢„è§ˆåŠŸèƒ½è¯Šæ–­...', 'info');
            
            setTimeout(() => {
                const threeOK = testThreeJS();
                
                setTimeout(() => {
                    const controlsOK = testOrbitControls();
                    
                    if (threeOK) {
                        setTimeout(() => {
                            const sceneOK = testBasicScene();
                            
                            setTimeout(() => {
                                testCustomPreview();
                            }, 1000);
                        }, 500);
                    }
                }, 500);
            }, 1000);
        });
    </script>
</body>
</html> 