<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D预览调试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .preview-container {
            width: 100%;
            height: 400px;
            border: 2px solid #007bff;
            border-radius: 5px;
            background: #f8f9fa;
            position: relative;
        }
        .log {
            background: #333;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔬 3D预览功能调试</h1>
        
        <div class="test-section">
            <h3>1. Three.js库加载测试</h3>
            <div id="threejs-status" class="info">检查中...</div>
        </div>
        
        <div class="test-section">
            <h3>2. OrbitControls加载测试</h3>
            <div id="controls-status" class="info">检查中...</div>
        </div>
        
        <div class="test-section">
            <h3>3. 基础Three.js场景测试</h3>
            <div id="basic-scene" class="preview-container">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div>基础3D场景测试</div>
                    <div id="basic-status">初始化中...</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>4. 自定义预览类测试</h3>
            <div id="custom-preview" class="preview-container">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div>晶体预览测试</div>
                    <div id="custom-status">等待测试...</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>5. CIF解析测试</h3>
            <textarea id="cif-input" rows="10" cols="80" placeholder="请粘贴CIF文件内容进行测试...">
data_simple_crystal
_cell_length_a    5.6402
_cell_length_b    5.6402
_cell_length_c    5.6402
_cell_angle_alpha 90.0
_cell_angle_beta  90.0
_cell_angle_gamma 90.0
_space_group_name_H-M_alt 'F m -3 m'
_space_group_IT_number 225

loop_
_atom_site_label
_atom_site_type_symbol
_atom_site_fract_x
_atom_site_fract_y
_atom_site_fract_z
Na1 Na 0.0 0.0 0.0
Na2 Na 0.0 0.5 0.5
Na3 Na 0.5 0.0 0.5
Na4 Na 0.5 0.5 0.0
Cl1 Cl 0.5 0.5 0.5
Cl2 Cl 0.5 0.0 0.0
Cl3 Cl 0.0 0.5 0.0
Cl4 Cl 0.0 0.0 0.5
            </textarea>
            <br><br>
            <button onclick="testCIFParsing()">测试CIF解析</button>
            <div id="cif-status"></div>
        </div>
        
        <div class="test-section">
            <h3>6. 调试日志</h3>
            <div id="debug-log" class="log">等待日志...</div>
            <button onclick="clearLog()">清除日志</button>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    
    <!-- 自定义预览类 -->
    <script src="/static/js/crystal_preview.js"></script>
    <script src="/static/js/advanced_crystal_preview.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = 'Log cleared.';
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = type;
        }

        // 1. 检查Three.js
        function testThreeJS() {
            log('🔍 检查Three.js库...');
            if (typeof THREE !== 'undefined') {
                updateStatus('threejs-status', '✅ Three.js已成功加载', 'success');
                log('✅ Three.js版本: ' + THREE.REVISION, 'success');
                return true;
            } else {
                updateStatus('threejs-status', '❌ Three.js未加载', 'error');
                log('❌ Three.js未加载', 'error');
                return false;
            }
        }

        // 2. 检查OrbitControls
        function testOrbitControls() {
            log('🔍 检查OrbitControls...');
            if (typeof THREE !== 'undefined' && THREE.OrbitControls) {
                updateStatus('controls-status', '✅ OrbitControls已加载', 'success');
                log('✅ OrbitControls可用', 'success');
                return true;
            } else {
                updateStatus('controls-status', '❌ OrbitControls未加载', 'error');
                log('❌ OrbitControls不可用', 'error');
                return false;
            }
        }

        // 3. 测试基础Three.js场景
        function testBasicScene() {
            log('🔍 创建基础Three.js场景...');
            try {
                const container = document.getElementById('basic-scene');
                
                // 清空容器
                container.innerHTML = '';
                
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setClearColor(0xf0f0f0);
                container.appendChild(renderer.domElement);
                
                // 添加灯光
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                scene.add(directionalLight);
                
                // 创建一个旋转的立方体
                const geometry = new THREE.BoxGeometry();
                const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);
                
                // 添加OrbitControls
                if (THREE.OrbitControls) {
                    const controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.25;
                }
                
                camera.position.z = 5;
                
                // 动画循环
                function animate() {
                    requestAnimationFrame(animate);
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                    renderer.render(scene, camera);
                }
                animate();
                
                updateStatus('basic-status', '✅ 基础3D场景运行正常', 'success');
                log('✅ 基础Three.js场景创建成功', 'success');
                return true;
                
            } catch (error) {
                updateStatus('basic-status', '❌ 基础场景创建失败', 'error');
                log('❌ 基础场景错误: ' + error.message, 'error');
                return false;
            }
        }

        // 4. 测试自定义预览类
        function testCustomPreview() {
            log('🔍 测试自定义预览类...');
            try {
                const container = document.getElementById('custom-preview');
                container.innerHTML = '';
                
                // 检查预览类是否存在
                if (typeof AdvancedCrystalPreview !== 'undefined') {
                    log('✅ AdvancedCrystalPreview类已加载', 'success');
                    
                    // 创建预览实例
                    const preview = new AdvancedCrystalPreview('custom-preview');
                    
                    // 创建一个简单的测试结构
                    const testStructure = {
                        sites: [
                            { coords: [0, 0, 0], species: [{ element: 'Na', occu: 1 }] },
                            { coords: [2, 2, 2], species: [{ element: 'Cl', occu: 1 }] }
                        ],
                        lattice: {
                            matrix: [[4, 0, 0], [0, 4, 0], [0, 0, 4]]
                        }
                    };
                    
                    preview.loadStructureFromPymatgenStyle(testStructure);
                    
                    updateStatus('custom-status', '✅ 自定义预览类工作正常', 'success');
                    log('✅ AdvancedCrystalPreview测试成功', 'success');
                    return true;
                    
                } else if (typeof CrystalPreview !== 'undefined') {
                    log('⚠️ 回退到基础CrystalPreview', 'warning');
                    
                    const preview = new CrystalPreview('custom-preview');
                    updateStatus('custom-status', '⚠️ 使用基础预览类', 'warning');
                    log('⚠️ 使用基础CrystalPreview', 'warning');
                    return true;
                    
                } else {
                    updateStatus('custom-status', '❌ 预览类未加载', 'error');
                    log('❌ 无可用的预览类', 'error');
                    return false;
                }
                
            } catch (error) {
                updateStatus('custom-status', '❌ 预览类测试失败', 'error');
                log('❌ 自定义预览错误: ' + error.message, 'error');
                return false;
            }
        }

        // 5. 测试CIF解析
        function testCIFParsing() {
            log('🔍 测试CIF解析...');
            const cifInput = document.getElementById('cif-input').value;
            const statusDiv = document.getElementById('cif-status');
            
            try {
                // 这里应该调用CIF解析函数
                // 暂时只做基本验证
                if (cifInput.includes('_cell_length_a') && cifInput.includes('_atom_site_label')) {
                    statusDiv.innerHTML = '<div class="success">✅ CIF格式检查通过</div>';
                    log('✅ CIF格式验证成功', 'success');
                } else {
                    statusDiv.innerHTML = '<div class="error">❌ CIF格式不完整</div>';
                    log('❌ CIF格式验证失败', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="error">❌ CIF解析错误: ' + error.message + '</div>';
                log('❌ CIF解析错误: ' + error.message, 'error');
            }
        }

        // 页面加载时运行所有测试
        window.addEventListener('load', function() {
            log('🚀 开始3D预览功能诊断...', 'info');
            
            setTimeout(() => {
                const threeOK = testThreeJS();
                
                setTimeout(() => {
                    const controlsOK = testOrbitControls();
                    
                    if (threeOK) {
                        setTimeout(() => {
                            const sceneOK = testBasicScene();
                            
                            setTimeout(() => {
                                testCustomPreview();
                            }, 1000);
                        }, 500);
                    }
                }, 500);
            }, 1000);
        });
    </script>
</body>
</html> 